gsap.registerPlugin(ScrollTrigger);const clientId="e68b332488db43fb8639650151541950",homepageUri="http://127.0.0.1:5500/",redirectUri="http://127.0.0.1:5500/",scope="user-top-read",colours=["#ff99c8","#fcf6bd","#d0f4de","#a9def9","#e4c1f9","#ff595e","#ffca3a","#8ac926","#3CADF3","#9F6FE2","#f4a261","#2a9d8f","#e9c46a","#4D8EA8","#e76f51"];let chartScrollTriggers=[0,0,0,0];const chartInfo={popularity:{title:"Popularity",yDomain:[0,100],info:"Based on the total number of plays and how recent they were, 100 being most popular",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Popularity out of 100"},tempo:{title:"Tempo",yDomain:[0,250],info:"Estimated tempo in beats per minute",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Beats per minute"},valence:{title:"Positivity",yDomain:[0,1],info:"An indicator of cheerful or euphoric music vs sad or angry music, 1 being most positive",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Valence"},danceability:{title:"Danceability",yDomain:[0,1],info:"Suitability for dancing, based on tempo, rhythm and beat strength, 1 being most danceable",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Danceability"}};let resizeTimeout,playingTrackId="",currentTimePeriod="";function login(){window.location=`https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${encodeURIComponent("user-top-read")}&response_type=token&show_dialog=false`}function logout(){localStorage.removeItem("access_token"),localStorage.removeItem("spotifyData"),window.location=homepageUri}async function handlePageLoadOrRedirect(){if(getLocalStorageWithTimestamp("access_token")){await makeApiCall();const e=getLocalStorageWithTimestamp("spotifyData").long_term;currentTimePeriod="long_term",activateTimeRangeBtn(),document.querySelector(".splash_section").remove(),buildSite(e)}else{document.querySelector(".splash_section").classList.remove("hidden");const e=new URLSearchParams(window.location.hash.substring(1)).get("access_token");e&&(setLocalStorageWithTimestamp("access_token",e),window.location=homepageUri)}}function buildSite(e){if(document.querySelector("main").classList.remove("hidden"),ScrollTrigger.getAll().forEach((e=>e.kill(!0))),e.artists.length<1||e.tracks.length<1){const e=document.querySelector(".splash_title"),t=document.querySelector(".arrow");return e.innerHTML="No Spotify data available for that time period, sorry!",t.style.display="none",void deleteSections()}document.querySelector(".splash_title").innerHTML="Scroll to view your wrap",document.querySelector(".arrow").style.display="block",deleteSections(),buildTopArtistsSectopn(e),buildTopTracksSection(e),buildListeningSection(e),buildRecommendationSection(e),buildTriggers(e)}function deleteSections(){const e=document.querySelector(".artists_section"),t=document.querySelector(".tracks_section"),n=document.querySelector(".listening_section"),a=document.querySelector(".recommendation_section");e&&t&&n&&a&&(e.remove(),t.remove(),n.remove(),a.remove(),ScrollTrigger.getAll().forEach((e=>e.kill(!0))))}function buildTopArtistsSectopn(e){let t=document.querySelector(".artists_section");t&&t.remove();const n=Object.assign(document.createElement("section"),{className:"artists_section"});document.querySelector("main").appendChild(n);const a=e.artists.slice(0,5);n.style.height=100*a.length+"lvh";const i=Object.assign(document.createElement("div"),{className:"artist_slider_wrapper"});n.appendChild(i);const r=Object.assign(document.createElement("div"),{className:"header_container"});i.appendChild(r);const s=Object.assign(document.createElement("div"),{className:"header_content"});r.appendChild(s);const c=Object.assign(document.createElement("div"),{textContent:"Your fave artists"});s.appendChild(c);const o=Object.assign(document.createElement("div"),{className:"artist_panels_wrapper"});i.appendChild(o),a.forEach(((e,t)=>{const n=Object.assign(document.createElement("div"),{className:"artist_panel"});n.style.backgroundColor=colours[4-(a.length-1)+t];const i=Object.assign(document.createElement("p"),{className:"artist_position",textContent:`#${t+1}`}),r=Object.assign(document.createElement("a"),{href:e.external_urls.spotify,target:"_blank"}),s=Object.assign(document.createElement("div"),{className:"images_wrapper"}),c=Object.assign(document.createElement("img"),{src:e.images[1].url,alt:e.name}),l=Object.assign(document.createElement("img"),{src:e.images[1].url,alt:e.name}),d=Object.assign(document.createElement("div"),{className:"artist_name"}),p=Object.assign(document.createElement("p"),{textContent:e.name});n.appendChild(i),s.appendChild(c),s.appendChild(l),r.appendChild(s),n.appendChild(r),d.appendChild(p),n.appendChild(d),o.appendChild(n)}))}function buildTopTracksSection(e){let t=document.querySelector(".tracks_section");t&&t.remove();const n=Object.assign(document.createElement("section"),{className:"tracks_section"});document.querySelector("main").appendChild(n);const a=e.tracks.slice(0,5),i=Object.assign(document.createElement("div"),{className:"tracks_wrapper"}),r=Object.assign(document.createElement("div"),{className:"tracks_left_wrapper"}),s=Object.assign(document.createElement("div"),{innerHTML:"Your top songs"}),c=Object.assign(document.createElement("div"),{className:"tracks_right_wrapper"});r.appendChild(s),i.appendChild(r),i.appendChild(c),n.appendChild(i),a.forEach(((e,t)=>{const n=Object.assign(document.createElement("div"),{className:"track_panel_wrapper"}),a=Object.assign(document.createElement("div"),{className:"track_panel_content"}),i=Object.assign(document.createElement("p"),{className:"index_par",textContent:`#${t+1}`}),r=Object.assign(document.createElement("div"),{className:"track_image_wrapper"}),s=Object.assign(document.createElement("img"),{id:t.toString(),src:e.album.images[1].url,alt:e.name,className:"track_image"}),o=Object.assign(document.createElement("div"),{className:"track_labels_wrapper"}),l=Object.assign(document.createElement("p"),{className:"track_name_label",textContent:e.name}),d=Object.assign(document.createElement("p"),{className:"track_artist_label",textContent:e.artists[0].name}),p=Object.assign(document.createElement("div"),{className:"track_buttons_wrapper"}),m=Object.assign(document.createElement("a"),{className:"spotify_link",target:"_blank",href:e.external_urls.spotify}),u=Object.assign(document.createElement("img"),{className:"spotify_icon",src:"static/Spotify_Icon_RGB_Black.png"});if(c.appendChild(n),n.appendChild(a),a.appendChild(i),r.appendChild(s),a.appendChild(r),a.appendChild(o),o.appendChild(l),o.appendChild(d),o.appendChild(p),p.appendChild(m),m.appendChild(u),e.preview_url){const[t,n]=createPlayBtnAndAudio(e.id,e.preview_url);p.appendChild(n),p.appendChild(t),n.addEventListener("click",(t=>handlePlayClick(t,e.id)))}}))}function buildListeningSection(e){let t=document.querySelector(".listening_section");t&&t.remove();const n=Object.assign(document.createElement("section"),{className:"listening_section",innerHTML:' <div class="listening_intro">\n    <div class="splash_card">\n      <h1 class="splash_title">Your listening stats</h1>\n      <svg\n        xmlns="http://www.w3.org/2000/svg"\n        viewBox="0 0 384 512"\n        class="arrow bounce"\n      >\n        <path\n          d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"\n        />\n      </svg>\n    </div>\n    <p>Based on data from your top 50 tracks, with trend line</p>\n  </div>\n  <div class="listening_charts_wrapper"></div>'});document.querySelector("main").appendChild(n),createChart(e.tracks,"popularity",5),createChart(e.tracks,"tempo",6),createChart(e.tracks,"valence",7),createChart(e.tracks,"danceability",8)}function buildRecommendationSection(e){const t=Object.assign(document.createElement("section"),{className:"recommendation_section",innerHTML:'\n    <div class="recommendation_wrapper">\n      <div class="header_container">\n        <div class="header_content">\n          <div class="">Music recommendations</div>\n        </div>\n      </div>\n      <div class=\'vinyl_wrapper\'>\n\n          <img src="/static/vinyl.webp" class="vinyl_img"></img>\n          <div class="vinyl_shadow"></div>\n\n      </div>\n    </div>\n    <div class="recommendation_parent_wrapper">\n      <div class="recommendation_content_wrapper"></div>\n    </div>\n      '});document.querySelector("main").appendChild(t);const n=document.querySelector(".recommendation_parent_wrapper"),a=document.querySelector(".recommendation_content_wrapper");e.recommendations.forEach(((e,t)=>{let i=`\n    <div class="rec_content_wrapper">\n      <div class="rec_image_wrapper">\n        <img\n          src="${e.album.images[e.album.images.length-1].url}"\n          alt="Great Southern Land"\n          class="rec_image"\n        />\n      </div>\n      <div class="track_buttons_wrapper"></div>\n      <div class="rec_info_wrapper">\n        <p class="">${e.name}</p>\n        <p class="">${e.artists[0].name}</p>\n      </div>\n    </div>`;const r=Object.assign(document.createElement("div"),{innerHTML:i,className:"rec_wrapper"}),s=r.querySelector(".track_buttons_wrapper"),c=Object.assign(document.createElement("a"),{className:"spotify_link",target:"_blank",href:e.external_urls.spotify}),o=Object.assign(document.createElement("img"),{className:"spotify_icon",src:"static/Spotify_Icon_RGB_Black.png"});if(n.appendChild(a),a.appendChild(r),s.appendChild(c),c.appendChild(o),e.preview_url){const[t,n]=createPlayBtnAndAudio(e.id,e.preview_url);s.appendChild(n),s.appendChild(t),n.addEventListener("click",(t=>handlePlayClick(t,e.id)))}})),a.appendChild(Object.assign(document.createElement("div"),{innerHTML:'<div class="rec_content_wrapper">\n    <div class="rec_image_wrapper">\n      <img\n        src="./static/Spotify_Icon_RGB_Black.png"\n        alt="Great Southern Land"\n        class="rec_image"\n      />\n    </div>\n    <div class="rec_info_wrapper">\n      <p class="">Thank you for scrolling</p>\n      <p class="">I hope you enjoyed your wrap</p>\n    </div>\n  </div>',className:"rec_wrapper"}))}function createChart(e,t,n){const a=Object.assign(document.createElement("div"),{className:"chart_container_wrapper"}),i=Object.assign(document.createElement("div"),{className:"chart_wrapper"}),r=Object.assign(document.createElement("p"),{className:"chart_title",textContent:chartInfo[t].title}),s=Object.assign(document.createElement("div"),{className:"chart_content_wrapper",id:`${t}_chart`});s.style.backgroundColor=colours[n];const c=Object.assign(document.createElement("p"),{className:"chart_info",textContent:chartInfo[t].info}),o=Object.assign(document.createElement("div"),{id:`tooltip_${t}`});s.appendChild(o),a.appendChild(i),i.appendChild(r),i.appendChild(c),i.appendChild(s),document.querySelector(".listening_charts_wrapper").appendChild(a),function(){d3.select(`#${t}_chart`).select("svg").remove();const a=20,i=20,r=30,s=50;let c=parseInt(d3.select(`#${t}_chart`).style("width"))-s-i,o=.5*window.innerHeight-a-r;const l=d3.select(`#${t}_chart`).append("svg").attr("viewBox",`0 0 ${c+s+i} ${o+a+r}`).append("g").attr("transform",`translate(${s},${a})`),d=d3.scaleLinear().domain([1,e.length]).range([0,c]),p=d3.scaleLinear().domain([0,d3.max(e,(e=>e[t]))]).range([o,0]).nice(),m=l.append("g").attr("transform",`translate(0,${o})`).call(d3.axisBottom(d).tickValues(d3.range(1,e.length+1).filter((e=>1===e||e%5==0))).tickFormat((e=>e))),u=l.append("g").call(d3.axisLeft(p));m.append("text").attr("y",35).attr("x",c/2).attr("text-anchor","middle").attr("fill","black").text(chartInfo[t].xAxisLabel),u.append("text").attr("transform","rotate(-90)").attr("y",-35).attr("x",-o/2).attr("text-anchor","middle").attr("fill","black").text(chartInfo[t].yAxisLabel);const g=function(e,t){const n=e.length;let a=0,i=0,r=0,s=0;e.forEach(((e,n)=>{a+=n,i+=e[t],r+=n*e[t],s+=n*n}));const c=a/n,o=i/n,l=(r-a*o)/(s-a*c);return{slope:l,intercept:o-l*c}}(e,t);!function(e,n,a,i,r){const s=d3.line().x(((e,t)=>n(t+1))).y(((e,t)=>a(r.slope*t+r.intercept)));let c=e.append("path").datum(i).attr("class","trendline").attr("id",`trend_${t}`).attr("d",s).attr("fill","none").attr("opacity",.5).attr("stroke","white").attr("stroke-width",5).style("stroke-dasharray",document.querySelector(`#trend_${t}`).getTotalLength()).style("stroke-dashoffset",document.querySelector(`#trend_${t}`).getTotalLength()),o=n(1),l=a(1*r.slope+r.intercept),d=n(i.length),p=a(r.slope*i.length+r.intercept),m=Math.atan2(p-l,d-o)*(180/Math.PI);e.append("text").attr("class","trend_line_label").attr("x",o).attr("y",p).attr("dy","-10").attr("text-anchor","start").attr("opacity",0).attr("fill","white").attr("transform",`rotate(${m},${d},${p})`).text("Overall trend")}(l,d,p,e,g),l.selectAll("a").data(e).enter().append("a").attr("xlink:href",(e=>e.external_urls.spotify)).attr("target","_blank").append("circle").attr("class","hidden").attr("fill",colours[n-5]).attr("r",5).attr("cx",((e,t)=>d(t+1))).attr("cy",(e=>p(e[t]))).on("mouseover",(function(n,a){const i=d3.select(`#tooltip_${t}`).style("opacity",1).style("visibility","visible").style("left",n.layerX+10+"px").style("top",n.layerY-10+"px").html(function(e,n){return`\n        <div>\n          <div class="chart_popup_image_container">\n            <img src="${e.album.images[e.album.images.length-1].url}"/>\n          </div>\n        </div>\n        <div>\n          <p>\n            #${n+1}\n            <br>\n            ${e.name}\n            <br>\n            ${e.artists[0].name}\n            <br>\n            ${a=chartInfo[t].title,a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()}: ${e[t]}\n          </p>\n        </div>\n        `;var a}(a,e.findIndex((e=>e.id===a.id))));!function(e){const t=e.getBoundingClientRect().right-window.innerWidth;if(t>0){const n=parseFloat(e.style.left),a=parseFloat(e.style.top);e.style.left=n-t-20+"px",e.style.top=`${a+25}px`}}(i.node())})).on("mouseout",(function(){d3.select(`#tooltip_${t}`).style("opacity",0).style("visibility","hidden")}))}()}function createPlayBtnAndAudio(e,t){const n=document.createElement("audio");n.id=`audio-${e}`,n.src=t,n.setAttribute("data-wave-id",e);const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.id=`play-${e}`,a.setAttribute("xmlns","http://www.w3.org/2000/svg"),a.setAttribute("height","2em"),a.setAttribute("viewBox","0 0 512 512"),a.setAttribute("class","play_icon");const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d","M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9V344c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z"),a.appendChild(i),[n,a]}function handlePlayClick(e,t){if(e.preventDefault(),playingTrackId&&playingTrackId!==`audio-${t}`){document.getElementById(playingTrackId).pause()}const n=document.getElementById(`play-${t}`),a=document.getElementById(`audio-${t}`);a.volume=.1,a.addEventListener("play",(()=>{n.classList.add("animate-spin")})),a.addEventListener("pause",(()=>{n.classList.remove("animate-spin")})),a.paused?(a.play(),playingTrackId=`audio-${t}`):(a.pause(),playingTrackId="")}function buildTriggers(e){let t=e.tracks.slice(0,5);buildArtistSectionTriggers(),buildTracksSectionTriggers(t.length),buildListeningSectionTriggers(e.tracks.length),buildRecommendationSectionTriggers()}function buildArtistSectionTriggers(){let e=gsap.utils.toArray(".artist_panel"),t=gsap.to(e,{x:e=>-window.innerWidth*e,duration:e=>e,ease:"none",scrollTrigger:{trigger:".artists_section",start:"top top",scrub:!0,end:"bottom bottom"}});e.forEach((e=>{ScrollTrigger.create({trigger:e,containerAnimation:t,start:"left left"})}))}function buildTracksSectionTriggers(e){const t=gsap.timeline({scrollTrigger:{trigger:".tracks_wrapper",start:"top top",end:"bottom bottom",scrub:!0}});colours.forEach(((n,a)=>{a>=e&&a<2*e&&t.to(".tracks_wrapper",{backgroundColor:n})}))}function buildListeningSectionTriggers(e){gsap.utils.toArray(".chart_wrapper").forEach((t=>{let n=t.querySelector(".trendline"),a=t.querySelector(".trend_line_label"),i=n?n.getTotalLength():0;ScrollTrigger.create({trigger:t,start:"top top",end:"bottom top ",onUpdate:r=>{d3.select(t).selectAll("circle").attr("class",((t,n)=>n>=Math.floor(r.progress*e)?"hidden":"")),a.style.opacity=.5*r.progress;let s=i+r.progress*i;n.style.strokeDasharray=s}})}))}function buildRecommendationSectionTriggers(){gsap.fromTo(".vinyl_shadow",{rotate:"45"},{rotate:"-45",ease:"linear",scrollTrigger:{trigger:".recommendation_section",start:"top bottom",end:"bottom top",scrub:1}}),gsap.to(".vinyl_img",{rotate:"360",ease:"linear",scrollTrigger:{trigger:".recommendation_section",start:"top bottom",end:"bottom top",scrub:1}})}function activateTimeRangeBtn(){document.querySelectorAll(".time_btn").forEach((e=>{e.classList.remove("active"),e.classList.contains(currentTimePeriod)&&e.classList.add("active")}))}function resetTimePeriod(e){return playingTrackId="",currentTimePeriod=e,activateTimeRangeBtn(),getLocalStorageWithTimestamp("spotifyData")[e]}function shortTerm(){buildSite(resetTimePeriod("short_term"))}function mediumTerm(){buildSite(resetTimePeriod("medium_term"))}function longTerm(){buildSite(resetTimePeriod("long_term"))}window.onload=handlePageLoadOrRedirect;let initialWidth=window.innerWidth;window.onresize=function(){let e=window.innerWidth;Math.abs(e-initialWidth)>2&&(clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){requestAnimationFrame((()=>{buildSite(getLocalStorageWithTimestamp("spotifyData")[currentTimePeriod]),window.scrollBy({y:window.scrollY,behavior:"instant"}),initialWidth=e}))}),50))};