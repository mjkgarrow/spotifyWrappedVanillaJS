function setLocalStorageWithTimestamp(e,t){const a={value:t,timestamp:(new Date).getTime()};localStorage.setItem(e,JSON.stringify(a))}function getLocalStorageWithTimestamp(e){const t=localStorage.getItem(e);if(t){const{value:e,timestamp:a}=JSON.parse(t);if((new Date).getTime()-a<36e5)return e;localStorage.removeItem("access_token"),localStorage.removeItem("spotifyData"),window.location=homepageUri}return null}function handleErrors(e){if(!e.ok)throw localStorage.removeItem("access_token"),localStorage.removeItem("spotifyData"),window.location=homepageUri,new Error(`Request failed with status ${e.status}`)}async function fetchWithHeaders(e,t={method:"GET"}){const a=getLocalStorageWithTimestamp("access_token");if(!a)throw new Error("Authentication required");const n=Object.assign({},t.headers,{Authorization:`Bearer ${a}`}),i=await fetch("https://api.spotify.com/"+e,{...t,headers:n});return handleErrors(i),i}async function getTopItems(e,t,a=50,n=0){try{let i=`v1/me/top/${e}`;const r=[];a&&a>0&&r.push(`limit=${a}`),n&&n>0&&r.push(`offset=${n}`),t&&r.push(`time_range=${t}`),r.length>0&&(i+=`?${r.join("&")}`);const s=await fetchWithHeaders(i);return await s.json()}catch(e){throw e}}async function getTracksFeatures(e,t){try{const a=`v1/audio-features?ids=${e.join()}`,n=await fetchWithHeaders(a);return{timeRange:t,...await n.json()}}catch(e){throw e}}async function getRecommendations(e,t,a){try{const n=`v1/recommendations?seed_genres=${e.join()}&seed_tracks=${t.join()}`,i=await fetchWithHeaders(n);return{timeRange:a,...await i.json()}}catch(e){throw e}}async function getAllUserData(){try{const[e,t,a]=await Promise.all([getProfile(),getPlaylists(),getFollowedArtists()]);return{user:e,playlists:t,following:a}}catch(e){throw e}}function getTopKeys(e,t,a){const n=e.slice(0,t).reduce(((e,t)=>(t[a].forEach((t=>{e[t]=(e[t]||0)+1})),e)),{});return Object.entries(n).sort((([,e],[,t])=>t-e)).map((([e])=>e))}async function makeApiCall(){try{const e=["long_term","medium_term","short_term"],t=["tracks","artists"].flatMap((t=>e.map((e=>getTopItems(t,e))))),a=organiseSpotifyData(await Promise.all(t),e);await processStatsAndReccomendations(a,e),setLocalStorageWithTimestamp("spotifyData",a)}catch(e){console.error("Error fetching top items:",e)}}function organiseSpotifyData(e,t){return t.reduce(((t,a)=>{const n=e.filter((e=>new URLSearchParams(new URL(e.href).search).get("time_range")===a)).reduce(((e,t)=>(e[t.href.includes("tracks")?"tracks":"artists"]=t.items,e)),{tracks:[],artists:[]});return t[a]=n,t}),{})}async function processStatsAndReccomendations(e,t){const a=[],n=[];for(const t in e)if(a.push(getTracksFeatures(e[t].tracks.map((e=>e.id)),t)),e[t].tracks.length>0){const a=e[t].tracks.reduce(((e,t)=>[...e,t.id]),[]),i=getTopKeys(e[t].artists,5,"genres");n.push(getRecommendations(i.slice(0,2),a.slice(0,3),t))}const i=await Promise.all(n),r=await Promise.all(a);t.forEach((t=>{let a=r.find((e=>e.timeRange===t)),n=i.find((e=>e.timeRange===t));n&&(e[t].recommendations=n.tracks),e[t].tracks=e[t].tracks.map((e=>{const t=a.audio_features.find((t=>t.id===e.id));return{...e,danceability:t.danceability,energy:t.energy,key:t.key,loudness:t.loudness,mode:t.mode,speechiness:t.speechiness,acousticness:t.acousticness,instrumentalness:t.instrumentalness,liveness:t.liveness,valence:t.valence,tempo:t.tempo,time_signature:t.time_signature}}))}))}gsap.registerPlugin(ScrollTrigger);const clientId="e68b332488db43fb8639650151541950",homepageUri="https://wrapmenow-vanilla.netlify.app/",redirectUri="https://wrapmenow-vanilla.netlify.app/",scope="user-top-read",colours=["#ff99c8","#fcf6bd","#d0f4de","#a9def9","#e4c1f9","#ff595e","#ffca3a","#8ac926","#3CADF3","#9F6FE2","#f4a261","#2a9d8f","#e9c46a","#4D8EA8","#e76f51"];let chartScrollTriggers=[0,0,0,0];const chartInfo={popularity:{title:"Popularity",yDomain:[0,100],info:"Based on the total number of plays and how recent they were, 100 being most popular",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Popularity out of 100"},tempo:{title:"Tempo",yDomain:[0,250],info:"Estimated tempo in beats per minute",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Beats per minute"},valence:{title:"Positivity",yDomain:[0,1],info:"An indicator of cheerful or euphoric music vs sad or angry music, 1 being most positive",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Valence"},danceability:{title:"Danceability",yDomain:[0,1],info:"Suitability for dancing, based on tempo, rhythm and beat strength, 1 being most danceable",xAxisLabel:"Rank of your most played tracks",yAxisLabel:"Danceability"}};let resizeTimeout,playingTrackId="",currentTimePeriod="";function login(){window.location=`https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${encodeURIComponent("user-top-read")}&response_type=token&show_dialog=false`}function logout(){localStorage.removeItem("access_token"),localStorage.removeItem("spotifyData"),window.location=homepageUri}async function handlePageLoadOrRedirect(){if(getLocalStorageWithTimestamp("access_token")){await makeApiCall();const e=getLocalStorageWithTimestamp("spotifyData").long_term;currentTimePeriod="long_term",activateTimeRangeBtn(),document.querySelector(".splash_section").remove(),buildSite(e)}else{document.querySelector(".splash_section").classList.remove("hidden");const e=new URLSearchParams(window.location.hash.substring(1)).get("access_token");e&&(setLocalStorageWithTimestamp("access_token",e),window.location=homepageUri)}}function buildSite(e){if(document.querySelector("main").classList.remove("hidden"),ScrollTrigger.getAll().forEach((e=>e.kill(!0))),e.artists.length<1||e.tracks.length<1){const e=document.querySelector(".splash_title"),t=document.querySelector(".arrow");return e.innerHTML="No Spotify data available for that time period, sorry!",t.style.display="none",void deleteSections()}document.querySelector(".splash_title").innerHTML="Scroll to view your wrap",document.querySelector(".arrow").style.display="block",deleteSections(),buildTopArtistsSectopn(e),buildTopTracksSection(e),buildListeningSection(e),buildRecommendationSection(e),buildTriggers(e)}function deleteSections(){const e=document.querySelector(".artists_section"),t=document.querySelector(".tracks_section"),a=document.querySelector(".listening_section"),n=document.querySelector(".recommendation_section");e&&t&&a&&n&&(e.remove(),t.remove(),a.remove(),n.remove(),ScrollTrigger.getAll().forEach((e=>e.kill(!0))))}function buildTopArtistsSectopn(e){let t=document.querySelector(".artists_section");t&&t.remove();const a=Object.assign(document.createElement("section"),{className:"artists_section"});document.querySelector("main").appendChild(a);const n=e.artists.slice(0,5);a.style.height=100*n.length+"lvh";const i=Object.assign(document.createElement("div"),{className:"artist_slider_wrapper"});a.appendChild(i);const r=Object.assign(document.createElement("div"),{className:"header_container"});i.appendChild(r);const s=Object.assign(document.createElement("div"),{className:"header_content"});r.appendChild(s);const o=Object.assign(document.createElement("div"),{textContent:"Your fave artists"});s.appendChild(o);const c=Object.assign(document.createElement("div"),{className:"artist_panels_wrapper"});i.appendChild(c),n.forEach(((e,t)=>{const a=Object.assign(document.createElement("div"),{className:"artist_panel"});a.style.backgroundColor=colours[4-(n.length-1)+t];const i=Object.assign(document.createElement("p"),{className:"artist_position",textContent:`#${t+1}`}),r=Object.assign(document.createElement("a"),{href:e.external_urls.spotify,target:"_blank"}),s=Object.assign(document.createElement("div"),{className:"images_wrapper"}),o=Object.assign(document.createElement("img"),{src:e.images[1].url,alt:e.name}),l=Object.assign(document.createElement("img"),{src:e.images[1].url,alt:e.name}),d=Object.assign(document.createElement("div"),{className:"artist_name"}),m=Object.assign(document.createElement("p"),{textContent:e.name});a.appendChild(i),s.appendChild(o),s.appendChild(l),r.appendChild(s),a.appendChild(r),d.appendChild(m),a.appendChild(d),c.appendChild(a)}))}function buildTopTracksSection(e){let t=document.querySelector(".tracks_section");t&&t.remove();const a=Object.assign(document.createElement("section"),{className:"tracks_section"});document.querySelector("main").appendChild(a);const n=e.tracks.slice(0,5),i=Object.assign(document.createElement("div"),{className:"tracks_wrapper"}),r=Object.assign(document.createElement("div"),{className:"tracks_left_wrapper"}),s=Object.assign(document.createElement("div"),{innerHTML:"Your top songs"}),o=Object.assign(document.createElement("div"),{className:"tracks_right_wrapper"});r.appendChild(s),i.appendChild(r),i.appendChild(o),a.appendChild(i),n.forEach(((e,t)=>{const a=Object.assign(document.createElement("div"),{className:"track_panel_wrapper"}),n=Object.assign(document.createElement("div"),{className:"track_panel_content"}),i=Object.assign(document.createElement("p"),{className:"index_par",textContent:`#${t+1}`}),r=Object.assign(document.createElement("div"),{className:"track_image_wrapper"}),s=Object.assign(document.createElement("img"),{id:t.toString(),src:e.album.images[1].url,alt:e.name,className:"track_image"}),c=Object.assign(document.createElement("div"),{className:"track_labels_wrapper"}),l=Object.assign(document.createElement("p"),{className:"track_name_label",textContent:e.name}),d=Object.assign(document.createElement("p"),{className:"track_artist_label",textContent:e.artists[0].name}),m=Object.assign(document.createElement("div"),{className:"track_buttons_wrapper"}),p=Object.assign(document.createElement("a"),{className:"spotify_link",target:"_blank",href:e.external_urls.spotify}),u=Object.assign(document.createElement("img"),{className:"spotify_icon",src:"static/Spotify_Icon_RGB_Black.png"});if(o.appendChild(a),a.appendChild(n),n.appendChild(i),r.appendChild(s),n.appendChild(r),n.appendChild(c),c.appendChild(l),c.appendChild(d),c.appendChild(m),m.appendChild(p),p.appendChild(u),e.preview_url){const[t,a]=createPlayBtnAndAudio(e.id,e.preview_url);m.appendChild(a),m.appendChild(t),a.addEventListener("click",(t=>handlePlayClick(t,e.id)))}}))}function buildListeningSection(e){let t=document.querySelector(".listening_section");t&&t.remove();const a=Object.assign(document.createElement("section"),{className:"listening_section",innerHTML:' <div class="listening_intro">\n    <div class="splash_card">\n      <h1 class="splash_title">Your listening stats</h1>\n      <svg\n        xmlns="http://www.w3.org/2000/svg"\n        viewBox="0 0 384 512"\n        class="arrow bounce"\n      >\n        <path\n          d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z"\n        />\n      </svg>\n    </div>\n    <p>Based on data from your top 50 tracks, with trend line</p>\n  </div>\n  <div class="listening_charts_wrapper"></div>'});document.querySelector("main").appendChild(a),createChart(e.tracks,"popularity",5),createChart(e.tracks,"tempo",6),createChart(e.tracks,"valence",7),createChart(e.tracks,"danceability",8)}function buildRecommendationSection(e){const t=Object.assign(document.createElement("section"),{className:"recommendation_section",innerHTML:'\n    <div class="recommendation_wrapper">\n      <div class="header_container">\n        <div class="header_content">\n          <div class="">Music recommendations</div>\n        </div>\n      </div>\n      <div class=\'vinyl_wrapper\'>\n\n          <img src="/static/vinyl.webp" class="vinyl_img"></img>\n          <div class="vinyl_shadow"></div>\n\n      </div>\n    </div>\n    <div class="recommendation_parent_wrapper">\n      <div class="recommendation_content_wrapper"></div>\n    </div>\n      '});document.querySelector("main").appendChild(t);const a=document.querySelector(".recommendation_parent_wrapper"),n=document.querySelector(".recommendation_content_wrapper");e.recommendations.forEach(((e,t)=>{let i=`\n    <div class="rec_content_wrapper">\n      <div class="rec_image_wrapper">\n        <img\n          src="${e.album.images[e.album.images.length-1].url}"\n          alt="Great Southern Land"\n          class="rec_image"\n        />\n      </div>\n      <div class="track_buttons_wrapper"></div>\n      <div class="rec_info_wrapper">\n        <p class="">${e.name}</p>\n        <p class="">${e.artists[0].name}</p>\n      </div>\n    </div>`;const r=Object.assign(document.createElement("div"),{innerHTML:i,className:"rec_wrapper"}),s=r.querySelector(".track_buttons_wrapper"),o=Object.assign(document.createElement("a"),{className:"spotify_link",target:"_blank",href:e.external_urls.spotify}),c=Object.assign(document.createElement("img"),{className:"spotify_icon",src:"static/Spotify_Icon_RGB_Black.png"});if(a.appendChild(n),n.appendChild(r),s.appendChild(o),o.appendChild(c),e.preview_url){const[t,a]=createPlayBtnAndAudio(e.id,e.preview_url);s.appendChild(a),s.appendChild(t),a.addEventListener("click",(t=>handlePlayClick(t,e.id)))}})),n.appendChild(Object.assign(document.createElement("div"),{innerHTML:'<div class="rec_content_wrapper">\n    <div class="rec_image_wrapper">\n      <img\n        src="./static/Spotify_Icon_RGB_Black.png"\n        alt="Great Southern Land"\n        class="rec_image"\n      />\n    </div>\n    <div class="rec_info_wrapper">\n      <p class="">Thank you for scrolling</p>\n      <p class="">I hope you enjoyed your wrap</p>\n    </div>\n  </div>',className:"rec_wrapper"}))}function createChart(e,t,a){const n=Object.assign(document.createElement("div"),{className:"chart_container_wrapper"}),i=Object.assign(document.createElement("div"),{className:"chart_wrapper"}),r=Object.assign(document.createElement("p"),{className:"chart_title",textContent:chartInfo[t].title}),s=Object.assign(document.createElement("div"),{className:"chart_content_wrapper",id:`${t}_chart`});s.style.backgroundColor=colours[a];const o=Object.assign(document.createElement("p"),{className:"chart_info",textContent:chartInfo[t].info}),c=Object.assign(document.createElement("div"),{id:`tooltip_${t}`});s.appendChild(c),n.appendChild(i),i.appendChild(r),i.appendChild(o),i.appendChild(s),document.querySelector(".listening_charts_wrapper").appendChild(n),function(){d3.select(`#${t}_chart`).select("svg").remove();const n=20,i=20,r=30,s=50;let o=parseInt(d3.select(`#${t}_chart`).style("width"))-s-i,c=.5*window.innerHeight-n-r;const l=d3.select(`#${t}_chart`).append("svg").attr("viewBox",`0 0 ${o+s+i} ${c+n+r}`).append("g").attr("transform",`translate(${s},${n})`),d=d3.scaleLinear().domain([1,e.length]).range([0,o]),m=d3.scaleLinear().domain([0,d3.max(e,(e=>e[t]))]).range([c,0]).nice(),p=l.append("g").attr("transform",`translate(0,${c})`).call(d3.axisBottom(d).tickValues(d3.range(1,e.length+1).filter((e=>1===e||e%5==0))).tickFormat((e=>e))),u=l.append("g").call(d3.axisLeft(m));p.append("text").attr("y",35).attr("x",o/2).attr("text-anchor","middle").attr("fill","black").text(chartInfo[t].xAxisLabel),u.append("text").attr("transform","rotate(-90)").attr("y",-35).attr("x",-c/2).attr("text-anchor","middle").attr("fill","black").text(chartInfo[t].yAxisLabel);const g=function(e,t){const a=e.length;let n=0,i=0,r=0,s=0;e.forEach(((e,a)=>{n+=a,i+=e[t],r+=a*e[t],s+=a*a}));const o=n/a,c=i/a,l=(r-n*c)/(s-n*o);return{slope:l,intercept:c-l*o}}(e,t);!function(e,a,n,i,r){const s=d3.line().x(((e,t)=>a(t+1))).y(((e,t)=>n(r.slope*t+r.intercept)));let o=e.append("path").datum(i).attr("class","trendline").attr("id",`trend_${t}`).attr("d",s).attr("fill","none").attr("opacity",.5).attr("stroke","white").attr("stroke-width",5).style("stroke-dasharray",document.querySelector(`#trend_${t}`).getTotalLength()).style("stroke-dashoffset",document.querySelector(`#trend_${t}`).getTotalLength()),c=a(1),l=n(1*r.slope+r.intercept),d=a(i.length),m=n(r.slope*i.length+r.intercept),p=Math.atan2(m-l,d-c)*(180/Math.PI);e.append("text").attr("class","trend_line_label").attr("x",c).attr("y",m).attr("dy","-10").attr("text-anchor","start").attr("opacity",0).attr("fill","white").attr("transform",`rotate(${p},${d},${m})`).text("Overall trend")}(l,d,m,e,g),l.selectAll("a").data(e).enter().append("a").attr("xlink:href",(e=>e.external_urls.spotify)).attr("target","_blank").append("circle").attr("class","hidden").attr("fill",colours[a-5]).attr("r",5).attr("cx",((e,t)=>d(t+1))).attr("cy",(e=>m(e[t]))).on("mouseover",(function(a,n){const i=d3.select(`#tooltip_${t}`).style("opacity",1).style("visibility","visible").style("left",a.layerX+10+"px").style("top",a.layerY-10+"px").html(function(e,a){return`\n        <div>\n          <div class="chart_popup_image_container">\n            <img src="${e.album.images[e.album.images.length-1].url}"/>\n          </div>\n        </div>\n        <div>\n          <p>\n            #${a+1}\n            <br>\n            ${e.name}\n            <br>\n            ${e.artists[0].name}\n            <br>\n            ${n=chartInfo[t].title,n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()}: ${e[t]}\n          </p>\n        </div>\n        `;var n}(n,e.findIndex((e=>e.id===n.id))));!function(e){const t=e.getBoundingClientRect().right-window.innerWidth;if(t>0){const a=parseFloat(e.style.left),n=parseFloat(e.style.top);e.style.left=a-t-20+"px",e.style.top=`${n+25}px`}}(i.node())})).on("mouseout",(function(){d3.select(`#tooltip_${t}`).style("opacity",0).style("visibility","hidden")}))}()}function createPlayBtnAndAudio(e,t){const a=document.createElement("audio");a.id=`audio-${e}`,a.src=t,a.setAttribute("data-wave-id",e);const n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.id=`play-${e}`,n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.setAttribute("height","2em"),n.setAttribute("viewBox","0 0 512 512"),n.setAttribute("class","play_icon");const i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.setAttribute("d","M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zM188.3 147.1c-7.6 4.2-12.3 12.3-12.3 20.9V344c0 8.7 4.7 16.7 12.3 20.9s16.8 4.1 24.3-.5l144-88c7.1-4.4 11.5-12.1 11.5-20.5s-4.4-16.1-11.5-20.5l-144-88c-7.4-4.5-16.7-4.7-24.3-.5z"),n.appendChild(i),[a,n]}function handlePlayClick(e,t){if(e.preventDefault(),playingTrackId&&playingTrackId!==`audio-${t}`){document.getElementById(playingTrackId).pause()}const a=document.getElementById(`play-${t}`),n=document.getElementById(`audio-${t}`);n.volume=.1,n.addEventListener("play",(()=>{a.classList.add("animate-spin")})),n.addEventListener("pause",(()=>{a.classList.remove("animate-spin")})),n.paused?(n.play(),playingTrackId=`audio-${t}`):(n.pause(),playingTrackId="")}function buildTriggers(e){let t=e.tracks.slice(0,5);buildArtistSectionTriggers(),buildTracksSectionTriggers(t.length),buildListeningSectionTriggers(e.tracks.length),buildRecommendationSectionTriggers()}function buildArtistSectionTriggers(){let e=gsap.utils.toArray(".artist_panel"),t=gsap.to(e,{x:e=>-window.innerWidth*e,duration:e=>e,ease:"none",scrollTrigger:{trigger:".artists_section",start:"top top",scrub:!0,end:"bottom bottom"}});e.forEach((e=>{ScrollTrigger.create({trigger:e,containerAnimation:t,start:"left left"})}))}function buildTracksSectionTriggers(e){const t=gsap.timeline({scrollTrigger:{trigger:".tracks_wrapper",start:"top top",end:"bottom bottom",scrub:!0}});colours.forEach(((a,n)=>{n>=e&&n<2*e&&t.to(".tracks_wrapper",{backgroundColor:a})}))}function buildListeningSectionTriggers(e){gsap.utils.toArray(".chart_wrapper").forEach((t=>{let a=t.querySelector(".trendline"),n=t.querySelector(".trend_line_label"),i=a?a.getTotalLength():0;ScrollTrigger.create({trigger:t,start:"top top",end:"bottom top ",onUpdate:r=>{d3.select(t).selectAll("circle").attr("class",((t,a)=>a>=Math.floor(r.progress*e)?"hidden":"")),n.style.opacity=.5*r.progress;let s=i+r.progress*i;a.style.strokeDasharray=s}})}))}function buildRecommendationSectionTriggers(){gsap.fromTo(".vinyl_shadow",{rotate:"45"},{rotate:"-45",ease:"linear",scrollTrigger:{trigger:".recommendation_section",start:"top bottom",end:"bottom top",scrub:1}}),gsap.to(".vinyl_img",{rotate:"360",ease:"linear",scrollTrigger:{trigger:".recommendation_section",start:"top bottom",end:"bottom top",scrub:1}})}function activateTimeRangeBtn(){document.querySelectorAll(".time_btn").forEach((e=>{e.classList.remove("active"),e.classList.contains(currentTimePeriod)&&e.classList.add("active")}))}function resetTimePeriod(e){return playingTrackId="",currentTimePeriod=e,activateTimeRangeBtn(),getLocalStorageWithTimestamp("spotifyData")[e]}function shortTerm(){buildSite(resetTimePeriod("short_term"))}function mediumTerm(){buildSite(resetTimePeriod("medium_term"))}function longTerm(){buildSite(resetTimePeriod("long_term"))}window.onload=handlePageLoadOrRedirect;let initialWidth=window.innerWidth;window.onresize=function(){let e=window.innerWidth;Math.abs(e-initialWidth)>2&&(clearTimeout(resizeTimeout),resizeTimeout=setTimeout((function(){requestAnimationFrame((()=>{buildSite(getLocalStorageWithTimestamp("spotifyData")[currentTimePeriod]),window.scrollBy({y:window.scrollY,behavior:"instant"}),initialWidth=e}))}),50))};